name: CD Pipeline

on:
    workflow_run:
        workflows: ["CI/CD Pipeline"]
        types:
            - completed
        branches:
            - main

permissions:
    contents: read
    packages: read

jobs:
    deploy:
        name: Deploy to NCP Server
        runs-on: ubuntu-latest
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        timeout-minutes: 10
        environment: production

        steps:
            - name: Checkout repository
              uses: actions/checkout@v5

            - name: Get latest version
              id: version
              run: |
                  VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "latest")
                  echo "version=${VERSION}" >> $GITHUB_OUTPUT
                  echo "üì¶ Deploying version: ${VERSION}"

            - name: Prepare docker-compose.yml
              run: |
                  mkdir -p deploy
                  envsubst < docker/docker-compose.yml > deploy/docker-compose.yml
              env:
                  GITHUB_REPOSITORY: ${{ github.repository }}

            - name: Copy docker-compose.yml to server
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.SSH_HOST }}
                  username: ${{ secrets.SSH_USER }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  port: ${{ secrets.SSH_PORT }}
                  source: "deploy/docker-compose.yml"
                  target: "/root/airoad-backend"
                  overwrite: true
                  strip_components: 1

            - name: Deploy to NCP server
              uses: appleboy/ssh-action@v1.2.0
              with:
                  host: ${{ secrets.SSH_HOST }}
                  username: ${{ secrets.SSH_USER }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  port: ${{ secrets.SSH_PORT }}
                  script: |
                      cd /root/airoad-backend

                      echo "üîê Logging into GHCR..."
                      echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

                      echo "üõë Stopping existing containers..."
                      docker-compose down || true

                      echo "üì¶ Pulling latest Docker image..."
                      docker pull ghcr.io/${{ github.repository }}:latest

                      echo "üóëÔ∏è Removing old containers and images..."
                      docker container prune -f
                      docker image prune -f

                      echo "üöÄ Starting new containers..."
                      docker-compose up -d

                      echo "üîç Checking container status..."
                      docker-compose ps

                      echo "üìã Application logs:"
                      docker-compose logs --tail=50 app

                      echo "‚úÖ Deployment completed successfully!"

            - name: Health check
              uses: appleboy/ssh-action@v1.2.0
              with:
                  host: ${{ secrets.SSH_HOST }}
                  username: ${{ secrets.SSH_USER }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  port: ${{ secrets.SSH_PORT }}
                  script: |
                      cd /root/airoad-backend

                      # Wait for container to start
                      echo "‚è≥ Waiting for container to start..."
                      sleep 10

                      # Check container status
                      if ! docker-compose ps | grep -q "Up"; then
                        echo "‚ùå Container is not running!"
                        docker-compose logs --tail=100 app
                        exit 1
                      fi

                      # Health check with retry
                      echo "üè• Performing health check..."
                      MAX_RETRIES=10
                      RETRY_COUNT=0

                      while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                        HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/actuator/health || echo "000")

                        if [ "$HEALTH_STATUS" = "200" ]; then
                          echo "‚úÖ Application is healthy!"
                          echo "üéâ Deployment successful - Version: ${{ steps.version.outputs.version }}"
                          exit 0
                        fi

                        RETRY_COUNT=$((RETRY_COUNT + 1))
                        echo "‚è≥ Retry $RETRY_COUNT/$MAX_RETRIES - Health check status: $HEALTH_STATUS"
                        sleep 5
                      done

                      echo "‚ùå Health check failed after $MAX_RETRIES retries"
                      echo "üìã Recent logs:"
                      docker-compose logs --tail=100 app
                      exit 1

            - name: Deployment summary
              if: always()
              run: |
                  if [ "${{ job.status }}" = "success" ]; then
                    echo "‚úÖ Deployment succeeded!"
                    echo "üîó Server: http://${{ secrets.SSH_HOST }}:8080"
                    echo "üì¶ Version: ${{ steps.version.outputs.version }}"
                    echo "üè• Health check: Passed"
                  else
                    echo "‚ùå Deployment failed!"
                    echo "Please check the logs above for details."
                  fi