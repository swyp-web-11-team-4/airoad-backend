<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>WebSocket Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7/bundles/stomp.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .info { background: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .info h3 { margin-top: 0; }
        .info code { background: #fff; padding: 2px 6px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>WebSocket í…ŒìŠ¤íŠ¸</h1>

    <div class="info">
        <h3>ğŸ“¡ ì‹¤ì‹œê°„ ë©”ì‹œì§• êµ¬ì¡° (ê²½ë¡œ êµ¬ë¶„ ë°©ì‹)</h3>
        <p><strong>êµ¬ë… ê²½ë¡œ:</strong></p>
        <ul>
            <li><code>/user/sub/chat/{chatRoomId}</code> - ì±„íŒ… ë©”ì‹œì§€</li>
            <li><code>/user/sub/schedule</code> - ì—¬í–‰ ì¼ì • DTO (AIë¡œë¶€í„° ë°›ì•„ì˜¤ëŠ” ì—¬í–‰ ì¼ì •, 1ì¼ ë‹¨ìœ„)</li>
        </ul>
        <p>ê° ê²½ë¡œëŠ” ë…ë¦½ì ìœ¼ë¡œ êµ¬ë…í•˜ë©°, ì„œë¡œ ë‹¤ë¥¸ DTO íƒ€ì…ì„ ì „ì†¡í•©ë‹ˆë‹¤.</p>
    </div>
    <div>
        <button onclick="connect()">ì—°ê²°</button>
        <button onclick="disconnect()">ì—°ê²° í•´ì œ</button>
    </div>
    <div style="margin-top: 20px;">
        <h3>ì±„íŒ… ë©”ì‹œì§€ í…ŒìŠ¤íŠ¸</h3>
        <input type="text" id="chatRoomId" value="1" placeholder="ì±„íŒ…ë°© ID">
        <input type="text" id="messageInput" value="ì•ˆë…•í•˜ì„¸ìš”" placeholder="ë©”ì‹œì§€">
        <button onclick="sendMessage()">ë©”ì‹œì§€ ì „ì†¡</button>
    </div>
    <div style="margin-top: 20px;">
        <h3>ì¼ì • êµ¬ë… í…ŒìŠ¤íŠ¸</h3>
        <button onclick="testSchedule()">ì¼ì • ë°ì´í„° ìš”ì²­</button>
    </div>
    <div style="margin-top: 20px;">
        <h3>ë¡œê·¸:</h3>
        <div id="log" style="border: 1px solid #ccc; padding: 10px; height: 400px; overflow-y: scroll;"></div>
    </div>

    <script>
        let stompClient = null;

        function addLog(message) {
            const log = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            log.innerHTML += `[${time}] ${message}<br>`;
            log.scrollTop = log.scrollHeight;
        }

        function connect() {
            addLog('ì—°ê²° ì‹œë„ ì¤‘...');
            const socket = new SockJS('http://localhost:8080/ws-stomp');
            stompClient = StompJs.Stomp.over(socket);

            stompClient.connect({}, function(frame) {
                addLog('âœ… ì—°ê²° ì„±ê³µ');
                addLog('ì‚¬ìš©ì ID: ' + frame.headers['user-name']);

                // 1. ì±„íŒ… ë©”ì‹œì§€ êµ¬ë…
                const chatRoomId = document.getElementById('chatRoomId').value;
                const chatDestination = '/user/sub/chat/' + chatRoomId;

                addLog('êµ¬ë… ê²½ë¡œ 1: ' + chatDestination);
                stompClient.subscribe(chatDestination, function(message) {
                    const response = JSON.parse(message.body);
                    addLog('ğŸ¤– [AI]: ' + response.content);
                });

                // 2. ì¼ì • ë°ì´í„° êµ¬ë…
                const scheduleDestination = '/user/sub/schedule';
                addLog('êµ¬ë… ê²½ë¡œ 2: ' + scheduleDestination);
                stompClient.subscribe(scheduleDestination, function(message) {
                    addLog('ğŸ“… ì¼ì • ë°ì´í„° ìˆ˜ì‹ : ' + message.body);
                    const schedule = JSON.parse(message.body);
                    addLog('ğŸ—“ï¸ ì—¬í–‰: ' + schedule.tripName + ' (ë‚ ì§œ: ' + schedule.date + ')');
                    addLog('ğŸ“ í™œë™: ' + schedule.activities.join(', '));
                });

                addLog('âœ… ëª¨ë“  êµ¬ë… ì™„ë£Œ (ì±„íŒ… + ì¼ì •)');

            }, function(error) {
                addLog('âŒ ì—°ê²° ì‹¤íŒ¨: ' + error);
            });
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
                addLog('ì—°ê²° í•´ì œë¨');
            }
        }

        function sendMessage() {
            if (stompClient === null || !stompClient.connected) {
                addLog('âŒ ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”');
                return;
            }

            const chatRoomId = document.getElementById('chatRoomId').value;
            const content = document.getElementById('messageInput').value;
            const destination = '/pub/chat/' + chatRoomId + '/message';

            const message = {
                content: content,
                messageType: 'TEXT'
            };

            // 1. ì¦‰ì‹œ ìì‹ ì˜ ë©”ì‹œì§€ UIì— í‘œì‹œ (í´ë¼ì´ì–¸íŠ¸ ì¸¡)
            addLog('ğŸ‘¤ [ë‚˜]: ' + content);

            // 2. ì„œë²„ë¡œ ì „ì†¡ (AI ì‘ë‹µë§Œ ê¸°ë‹¤ë¦¼)
            stompClient.send(destination, {}, JSON.stringify(message));
        }

        function testSchedule() {
            if (stompClient === null || !stompClient.connected) {
                addLog('âŒ ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”');
                return;
            }

            const destination = '/pub/test/schedule';
            addLog('ğŸ“¤ ì¼ì • ë°ì´í„° ìš”ì²­: ' + destination);

            stompClient.send(destination, {}, JSON.stringify({}));
            addLog('âœ… ìš”ì²­ ì™„ë£Œ (ì„œë²„ì—ì„œ /user/sub/scheduleë¡œ ì‘ë‹µ ì˜ˆì •)');
        }
    </script>
</body>
</html>
