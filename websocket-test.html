<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>WebSocket Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7/bundles/stomp.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .info { background: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .info h3 { margin-top: 0; }
        .info code { background: #fff; padding: 2px 6px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>WebSocket 테스트</h1>

    <div class="info">
        <h3>📡 실시간 메시징 구조 (경로 구분 방식)</h3>
        <p><strong>구독 경로:</strong></p>
        <ul>
            <li><code>/user/sub/chat/{chatRoomId}</code> - 채팅 메시지</li>
            <li><code>/user/sub/schedule</code> - 여행 일정 DTO (AI로부터 받아오는 여행 일정, 1일 단위)</li>
        </ul>
        <p>각 경로는 독립적으로 구독하며, 서로 다른 DTO 타입을 전송합니다.</p>
    </div>
    <div>
        <button onclick="connect()">연결</button>
        <button onclick="disconnect()">연결 해제</button>
    </div>
    <div style="margin-top: 20px;">
        <h3>채팅 메시지 테스트</h3>
        <input type="text" id="chatRoomId" value="1" placeholder="채팅방 ID">
        <input type="text" id="messageInput" value="안녕하세요" placeholder="메시지">
        <button onclick="sendMessage()">메시지 전송</button>
    </div>
    <div style="margin-top: 20px;">
        <h3>일정 구독 테스트</h3>
        <button onclick="testSchedule()">일정 데이터 요청</button>
    </div>
    <div style="margin-top: 20px;">
        <h3>로그:</h3>
        <div id="log" style="border: 1px solid #ccc; padding: 10px; height: 400px; overflow-y: scroll;"></div>
    </div>

    <script>
        let stompClient = null;

        function addLog(message) {
            const log = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            log.innerHTML += `[${time}] ${message}<br>`;
            log.scrollTop = log.scrollHeight;
        }

        function connect() {
            addLog('연결 시도 중...');
            const socket = new SockJS('http://localhost:8080/ws-stomp');
            stompClient = StompJs.Stomp.over(socket);

            stompClient.connect({}, function(frame) {
                addLog('✅ 연결 성공');
                addLog('사용자 ID: ' + frame.headers['user-name']);

                // 1. 채팅 메시지 구독
                const chatRoomId = document.getElementById('chatRoomId').value;
                const chatDestination = '/user/sub/chat/' + chatRoomId;

                addLog('구독 경로 1: ' + chatDestination);
                stompClient.subscribe(chatDestination, function(message) {
                    const response = JSON.parse(message.body);
                    addLog('🤖 [AI]: ' + response.content);
                });

                // 2. 일정 데이터 구독
                const scheduleDestination = '/user/sub/schedule';
                addLog('구독 경로 2: ' + scheduleDestination);
                stompClient.subscribe(scheduleDestination, function(message) {
                    addLog('📅 일정 데이터 수신: ' + message.body);
                    const schedule = JSON.parse(message.body);
                    addLog('🗓️ 여행: ' + schedule.tripName + ' (날짜: ' + schedule.date + ')');
                    addLog('📍 활동: ' + schedule.activities.join(', '));
                });

                addLog('✅ 모든 구독 완료 (채팅 + 일정)');

            }, function(error) {
                addLog('❌ 연결 실패: ' + error);
            });
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
                addLog('연결 해제됨');
            }
        }

        function sendMessage() {
            if (stompClient === null || !stompClient.connected) {
                addLog('❌ 먼저 연결해주세요');
                return;
            }

            const chatRoomId = document.getElementById('chatRoomId').value;
            const content = document.getElementById('messageInput').value;
            const destination = '/pub/chat/' + chatRoomId + '/message';

            const message = {
                content: content,
                messageType: 'TEXT'
            };

            // 1. 즉시 자신의 메시지 UI에 표시 (클라이언트 측)
            addLog('👤 [나]: ' + content);

            // 2. 서버로 전송 (AI 응답만 기다림)
            stompClient.send(destination, {}, JSON.stringify(message));
        }

        function testSchedule() {
            if (stompClient === null || !stompClient.connected) {
                addLog('❌ 먼저 연결해주세요');
                return;
            }

            const destination = '/pub/test/schedule';
            addLog('📤 일정 데이터 요청: ' + destination);

            stompClient.send(destination, {}, JSON.stringify({}));
            addLog('✅ 요청 완료 (서버에서 /user/sub/schedule로 응답 예정)');
        }
    </script>
</body>
</html>
